---
phase: 07-watchlist-price-display
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - frontend/src/components/panels/ChartPanel.tsx
  - frontend/package.json
autonomous: true

must_haves:
  truths:
    - "Clicking a ticker in the watchlist shows a larger price-over-time chart in the main chart area"
    - "Chart uses canvas-based rendering via lightweight-charts v5"
    - "Chart data is accumulated from the SSE stream since page load"
    - "Chart updates in real-time as new prices arrive"
  artifacts:
    - path: "frontend/src/components/panels/ChartPanel.tsx"
      provides: "Canvas-based financial chart with real-time updates"
      contains: "createChart"
    - path: "frontend/package.json"
      provides: "lightweight-charts dependency"
      contains: "lightweight-charts"
  key_links:
    - from: "frontend/src/components/panels/ChartPanel.tsx"
      to: "frontend/src/stores/watchlist-store.ts"
      via: "useWatchlistStore selector for selectedTicker"
      pattern: "useWatchlistStore.*selectedTicker"
    - from: "frontend/src/components/panels/ChartPanel.tsx"
      to: "frontend/src/stores/price-store.ts"
      via: "usePriceStore selector for priceHistory"
      pattern: "usePriceStore.*priceHistory"
    - from: "frontend/src/components/panels/ChartPanel.tsx"
      to: "lightweight-charts"
      via: "createChart and LineSeries imports"
      pattern: "import.*from.*lightweight-charts"
---

<objective>
Build the main chart panel using TradingView's Lightweight Charts v5, displaying real-time price data for the selected ticker.

Purpose: The chart area is the visual centerpiece of the trading terminal. When a user clicks a ticker in the watchlist, this panel shows a detailed price-over-time line chart with streaming data.

Output: A fully functional ChartPanel replacing the placeholder, with canvas-based rendering and real-time data updates from the price store.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PLAN.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-watchlist-price-display/07-RESEARCH.md
@.planning/phases/07-watchlist-price-display/07-01-SUMMARY.md
@frontend/src/stores/price-store.ts
@frontend/src/stores/watchlist-store.ts
@frontend/src/components/panels/ChartPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install lightweight-charts and build ChartPanel with real-time streaming data</name>
  <files>
    frontend/src/components/panels/ChartPanel.tsx
  </files>
  <action>
**1. Install lightweight-charts:**

```bash
cd frontend && npm install lightweight-charts@5.1.0
```

**2. Replace ChartPanel.tsx with full implementation:**

The ChartPanel uses lightweight-charts v5 with imperative useRef/useEffect pattern. Key points:

**Imports:**
```typescript
import { createChart, LineSeries, ColorType } from 'lightweight-charts';
import type { IChartApi, ISeriesApi } from 'lightweight-charts';
```

**Store selectors (granular):**
```typescript
const selectedTicker = useWatchlistStore((s) => s.selectedTicker);
const priceHistory = usePriceStore((s) => s.priceHistory);
```

**Refs:**
```typescript
const containerRef = useRef<HTMLDivElement>(null);
const chartRef = useRef<IChartApi | null>(null);
const seriesRef = useRef<ISeriesApi<'Line'> | null>(null);
```

**Chart creation (useEffect with empty deps):**

Create the chart instance ONCE on mount. This is critical -- never recreate on data changes.

```typescript
useEffect(() => {
  if (!containerRef.current) return;
  const chart = createChart(containerRef.current, {
    layout: {
      background: { type: ColorType.Solid, color: '#1a1a2e' },
      textColor: '#8b949e',
    },
    grid: {
      vertLines: { color: '#2d2d44' },
      horzLines: { color: '#2d2d44' },
    },
    timeScale: {
      borderColor: '#2d2d44',
      timeVisible: true,
      secondsVisible: true,
    },
    rightPriceScale: {
      borderColor: '#2d2d44',
    },
    width: containerRef.current.clientWidth,
    height: containerRef.current.clientHeight,
  });

  const series = chart.addSeries(LineSeries, {
    color: '#209dd7',
    lineWidth: 2,
  });

  chartRef.current = chart;
  seriesRef.current = series;

  // ResizeObserver for responsive sizing
  const observer = new ResizeObserver((entries) => {
    const { width, height } = entries[0].contentRect;
    chart.applyOptions({ width, height });
  });
  observer.observe(containerRef.current);

  return () => {
    observer.disconnect();
    chart.remove();
  };
}, []);
```

**Data sync (useEffect depending on selectedTicker and priceHistory):**

When selectedTicker changes OR priceHistory updates, sync the chart:

```typescript
useEffect(() => {
  if (!seriesRef.current || !selectedTicker) return;
  const history = priceHistory[selectedTicker];
  if (!history || history.length === 0) return;

  // setData replaces all data -- use this when selectedTicker changes
  // The time values must be in ascending order and are Unix seconds (from backend)
  seriesRef.current.setData(history);
  chartRef.current?.timeScale().fitContent();
}, [selectedTicker, priceHistory]);
```

IMPORTANT: `setData()` is correct here because we need to replace all chart data when the ticker changes, and we want to show the full accumulated history. The research note about preferring `update()` applies to appending single points, but since we're feeding the full history array from Zustand on every store update, `setData()` with the complete array is the right approach. Lightweight-charts is optimized for this pattern and only redraws changed portions.

**No-ticker state:**

When `selectedTicker` is null, show a centered message:

```typescript
if (!selectedTicker) {
  return (
    <div className="h-full w-full p-3 bg-terminal-surface flex items-center justify-center">
      <span className="text-text-muted font-mono text-xs uppercase tracking-wider">
        Select a ticker to view chart
      </span>
    </div>
  );
}
```

**Header with ticker name:**

Above the chart div, show the selected ticker symbol:

```typescript
<div className="h-full w-full flex flex-col bg-terminal-surface">
  <div className="px-3 pt-3 pb-1 flex items-center justify-between">
    <span className="text-text-muted font-mono text-xs uppercase tracking-wider">Chart</span>
    <span className="font-mono text-sm font-bold text-text-primary">{selectedTicker}</span>
  </div>
  <div ref={containerRef} className="flex-1 min-h-0" />
</div>
```

The `min-h-0` on the chart container is essential for flex children to not overflow. The `flex-1` makes it fill available space.

**CRITICAL lightweight-charts v5 notes (from research):**
- Use `chart.addSeries(LineSeries, options)` NOT `chart.addLineSeries(options)` (v4 API removed in v5)
- Import `LineSeries` and `ColorType` as values from 'lightweight-charts'
- Chart creation ONLY in useEffect (never during render) to avoid "window is not defined"
- Time values from backend are Unix seconds -- pass directly, do NOT multiply by 1000
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to verify no type errors. Run `cd frontend && npm run build` to verify static export succeeds (lightweight-charts must work with Next.js static export -- it should since chart creation is in useEffect only). Verify `lightweight-charts` appears in `frontend/package.json` dependencies.
  </verify>
  <done>
ChartPanel creates a canvas-based financial chart on mount using lightweight-charts v5. Chart shows price-over-time data for the selected ticker from priceHistory in the Zustand store. Chart resizes responsively via ResizeObserver. Dark theme matches terminal aesthetic. No-ticker state shows helpful message. `npm run build` succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- zero type errors
2. `cd frontend && npm run build` -- static export succeeds
3. `lightweight-charts` version 5.1.0 in package.json dependencies
4. ChartPanel.tsx contains: `createChart`, `LineSeries`, `ColorType`, `ResizeObserver`, `useWatchlistStore`, `usePriceStore`
5. No v4 API usage: grep for `addLineSeries` should find zero matches
6. Chart created only in useEffect (not at module scope or during render)
</verification>

<success_criteria>
- ChartPanel renders a canvas-based price chart for the selected ticker
- Chart data comes from priceHistory accumulated by SSE stream
- Chart updates in real-time as new prices arrive
- Chart resizes responsively within the CSS Grid layout
- Switching tickers replaces chart data with the new ticker's history
- Frontend builds to static export without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-watchlist-price-display/07-02-SUMMARY.md`
</output>
