---
phase: 07-watchlist-price-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/stores/price-store.ts
  - frontend/src/stores/watchlist-store.ts
  - frontend/src/app/globals.css
  - frontend/src/components/ui/Sparkline.tsx
  - frontend/src/components/ui/PriceCell.tsx
  - frontend/src/components/panels/WatchlistPanel.tsx
  - frontend/src/hooks/use-price-stream.ts
autonomous: true

must_haves:
  truths:
    - "Watchlist panel displays all watched tickers with symbol, current price, daily change %, and direction arrow"
    - "Price rows flash green on uptick and red on downtick with ~500ms CSS fade"
    - "Sparkline mini-charts beside each ticker show price history accumulated from SSE since page load"
    - "Clicking a ticker row selects it (visually highlighted)"
    - "User can add a ticker via input field and remove a ticker via button"
  artifacts:
    - path: "frontend/src/stores/price-store.ts"
      provides: "Price history accumulation per ticker from SSE"
      contains: "priceHistory"
    - path: "frontend/src/stores/watchlist-store.ts"
      provides: "Watchlist CRUD state and selected ticker"
      exports: ["useWatchlistStore"]
    - path: "frontend/src/components/ui/Sparkline.tsx"
      provides: "SVG polyline sparkline"
      exports: ["Sparkline"]
    - path: "frontend/src/components/ui/PriceCell.tsx"
      provides: "Single ticker row with flash animation"
      exports: ["PriceCell"]
    - path: "frontend/src/components/panels/WatchlistPanel.tsx"
      provides: "Full watchlist grid with CRUD controls"
      exports: ["WatchlistPanel"]
    - path: "frontend/src/app/globals.css"
      provides: "Flash animation keyframes"
      contains: "flash-up"
  key_links:
    - from: "frontend/src/components/panels/WatchlistPanel.tsx"
      to: "frontend/src/stores/watchlist-store.ts"
      via: "useWatchlistStore selectors"
      pattern: "useWatchlistStore"
    - from: "frontend/src/components/ui/PriceCell.tsx"
      to: "frontend/src/stores/price-store.ts"
      via: "usePriceStore selector for single ticker"
      pattern: "usePriceStore.*prices\\[ticker\\]"
    - from: "frontend/src/components/ui/Sparkline.tsx"
      to: "frontend/src/stores/price-store.ts"
      via: "priceHistory data array"
      pattern: "priceHistory"
    - from: "frontend/src/stores/watchlist-store.ts"
      to: "/api/watchlist"
      via: "fetch calls for CRUD"
      pattern: "fetch.*api/watchlist"
---

<objective>
Build the live watchlist panel with price flash animations, sparkline mini-charts, ticker selection, and add/remove controls.

Purpose: This is the primary data display surface of the trading terminal -- users see live prices updating in real-time with visual feedback for price direction.

Output: A fully functional WatchlistPanel replacing the placeholder, with supporting stores, components, and CSS animations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@planning/PLAN.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-watchlist-price-display/07-RESEARCH.md
@.planning/phases/06-frontend-foundation/06-01-SUMMARY.md
@frontend/src/stores/price-store.ts
@frontend/src/stores/portfolio-store.ts
@frontend/src/hooks/use-price-stream.ts
@frontend/src/app/globals.css
@frontend/src/app/page.tsx
@frontend/src/lib/api.ts
@frontend/src/components/panels/WatchlistPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend price store with history, create watchlist store, add flash CSS and Sparkline component</name>
  <files>
    frontend/src/stores/price-store.ts
    frontend/src/stores/watchlist-store.ts
    frontend/src/app/globals.css
    frontend/src/components/ui/Sparkline.tsx
    frontend/src/hooks/use-price-stream.ts
  </files>
  <action>
**1. Extend price-store.ts with priceHistory accumulation:**

Add `priceHistory: Record<string, { time: number; value: number }[]>` to the PriceStore interface. Update `setPrices` to append each incoming ticker's price to its history array. Cap each ticker's history at 5000 entries (slice off oldest if exceeded). Keep the existing `prices` field replacement as-is.

```typescript
interface PriceStore {
  prices: Record<string, PriceUpdate>;
  priceHistory: Record<string, { time: number; value: number }[]>;
  connectionStatus: ConnectionStatus;
  setPrices: (prices: Record<string, PriceUpdate>) => void;
  setConnectionStatus: (status: ConnectionStatus) => void;
}
```

In `setPrices`, use `set((state) => { ... })` functional form to access current state:
```typescript
setPrices: (incoming) => set((state) => {
  const newHistory = { ...state.priceHistory };
  for (const [ticker, update] of Object.entries(incoming)) {
    const existing = newHistory[ticker] || [];
    const appended = [...existing, { time: update.timestamp, value: update.price }];
    newHistory[ticker] = appended.length > 5000 ? appended.slice(-5000) : appended;
  }
  return { prices: incoming, priceHistory: newHistory };
}),
```

Initialize `priceHistory: {}` in the store defaults.

**2. Create watchlist-store.ts:**

New Zustand store for watchlist CRUD and ticker selection:

```typescript
interface WatchlistStore {
  tickers: string[];
  selectedTicker: string | null;
  loading: boolean;
  fetchWatchlist: () => Promise<void>;
  addTicker: (ticker: string) => Promise<void>;
  removeTicker: (ticker: string) => Promise<void>;
  selectTicker: (ticker: string) => void;
}
```

- `fetchWatchlist`: GET `/api/watchlist`, parse response, extract `items.map(i => i.ticker)` into `tickers`, set `loading: false`. On first load, auto-select first ticker if `selectedTicker` is null.
- `addTicker`: POST `/api/watchlist` with body `{ ticker: ticker.toUpperCase().trim() }`. On success, re-fetch watchlist. Do nothing if ticker already in list.
- `removeTicker`: DELETE `/api/watchlist/{ticker}`. On success, re-fetch watchlist. If removed ticker was selectedTicker, select first remaining ticker or null.
- `selectTicker`: sets `selectedTicker` to the given ticker.

Use the pattern from portfolio-store (direct fetch, no fetchJson helper needed for POST/DELETE).

**3. Update use-price-stream.ts:**

After the price stream hook, add a `useEffect` in page.tsx (not in the hook itself) that calls `fetchWatchlist()` on mount. Actually -- no changes needed to the hook file itself. The watchlist fetch will be wired in page.tsx in Task 2. Leave use-price-stream.ts unchanged.

**4. Add flash animation keyframes to globals.css:**

Append after the `@theme` block:

```css
@keyframes flash-up {
  0% { background-color: rgba(34, 197, 94, 0.3); }
  100% { background-color: transparent; }
}
@keyframes flash-down {
  0% { background-color: rgba(239, 68, 68, 0.3); }
  100% { background-color: transparent; }
}
.animate-flash-up {
  animation: flash-up 500ms ease-out;
}
.animate-flash-down {
  animation: flash-down 500ms ease-out;
}
```

**5. Create Sparkline.tsx component:**

Hand-rolled SVG sparkline at `frontend/src/components/ui/Sparkline.tsx`:

```typescript
interface SparklineProps {
  data: number[];
  width?: number;
  height?: number;
  color?: string;
}
```

- Accept an array of price values, default width=80, height=24, color='#209dd7' (brand-blue)
- If data.length < 2, return null (nothing to draw)
- Calculate min/max of data, compute SVG points mapping data indices to x and values to y
- Render `<svg>` with a single `<polyline>` element: fill="none", stroke={color}, strokeWidth={1.5}
- Use `vectorEffect="non-scaling-stroke"` for consistent line width
- Color the sparkline based on overall direction: if last value > first value use price-up green (#22c55e), if less use price-down red (#ef4444), otherwise use brand-blue
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to verify no type errors. Verify the new files exist and export correctly.
  </verify>
  <done>
price-store.ts accumulates priceHistory per ticker on each setPrices call with 5000-point cap. watchlist-store.ts exports useWatchlistStore with fetchWatchlist, addTicker, removeTicker, selectTicker. globals.css has flash-up and flash-down keyframe animations. Sparkline.tsx renders an SVG polyline from a number array with direction-based coloring.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build PriceCell with flash animation and full WatchlistPanel with CRUD controls</name>
  <files>
    frontend/src/components/ui/PriceCell.tsx
    frontend/src/components/panels/WatchlistPanel.tsx
    frontend/src/app/page.tsx
  </files>
  <action>
**1. Create PriceCell.tsx component:**

At `frontend/src/components/ui/PriceCell.tsx`, create a component that renders a single ticker row:

```typescript
interface PriceCellProps {
  ticker: string;
  isSelected: boolean;
  onSelect: (ticker: string) => void;
  onRemove: (ticker: string) => void;
}
```

Inside:
- Use granular Zustand selectors to minimize re-renders:
  - `const priceData = usePriceStore((s) => s.prices[ticker]);`
  - `const history = usePriceStore((s) => s.priceHistory[ticker]);`
- Extract from priceData: `price`, `change_percent`, `direction`
- Display layout (single row, horizontal):
  - Ticker symbol (font-mono, text-sm, font-bold, text-text-primary)
  - Sparkline component using `history?.map(h => h.value) ?? []` (limited to last 200 points for sparkline: `history?.slice(-200).map(...)`)
  - Current price formatted to 2 decimal places (font-mono, text-sm, text-text-primary)
  - Change percent formatted with sign and % (font-mono, text-xs): green text if positive, red if negative, muted if zero
  - Direction arrow: up arrow character for 'up', down arrow for 'down', dash for 'flat'
  - Remove button: small 'x' button, text-text-muted, hover:text-price-down, only visible on row hover
- Flash animation: wrap the row content in a div with `key={ticker + '-' + (priceData?.timestamp ?? 0)}`. Apply className `animate-flash-up` when direction is 'up', `animate-flash-down` when direction is 'down'.
- Selected state: add a left border accent (`border-l-2 border-brand-blue`) and slightly brighter background (`bg-terminal-border/30`) when isSelected is true.
- onClick on the row calls `onSelect(ticker)`.
- Use `cursor-pointer` on the row.

**2. Replace WatchlistPanel.tsx with full implementation:**

Replace the placeholder with a full watchlist grid:

- Header row: "WATCHLIST" label (font-mono, text-xs, uppercase, tracking-wider, text-text-muted) with a count badge
- Add ticker input: a small text input and "+" button at the top. Input is uppercase, font-mono. On submit (Enter or click +), call `addTicker`. Clear input after successful add.
- Ticker list: map over `tickers` from watchlist store, render a `PriceCell` for each. Pass `selectedTicker === ticker` as `isSelected`. Pass `selectTicker` as `onSelect`. Pass `removeTicker` as `onRemove`.
- Scrollable container: the ticker list should be in a `overflow-y-auto` container that fills available height.
- Loading state: show a "Loading..." text while `loading` is true.
- Empty state: show "No tickers" when tickers array is empty and not loading.

Zustand selectors in WatchlistPanel:
```typescript
const tickers = useWatchlistStore((s) => s.tickers);
const selectedTicker = useWatchlistStore((s) => s.selectedTicker);
const loading = useWatchlistStore((s) => s.loading);
const selectTicker = useWatchlistStore((s) => s.selectTicker);
const addTicker = useWatchlistStore((s) => s.addTicker);
const removeTicker = useWatchlistStore((s) => s.removeTicker);
```

**3. Update page.tsx to fetch watchlist on mount:**

Add import for `useWatchlistStore`. Add a `fetchWatchlist` selector and call it in the existing useEffect alongside fetchPortfolio:

```typescript
const fetchWatchlist = useWatchlistStore((s) => s.fetchWatchlist);

useEffect(() => {
  fetchPortfolio();
  fetchWatchlist();
}, [fetchPortfolio, fetchWatchlist]);
```
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to verify no type errors. Run `cd frontend && npm run build` to verify static export succeeds. Check that WatchlistPanel.tsx imports PriceCell, Sparkline, and the two stores. Confirm page.tsx calls fetchWatchlist on mount.
  </verify>
  <done>
PriceCell renders ticker symbol, sparkline, price, change%, direction arrow, and remove button with flash animation on price changes. WatchlistPanel shows full ticker grid with add/remove controls, scrollable list, loading/empty states. page.tsx fetches watchlist on mount. `npm run build` succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` -- zero type errors
2. `cd frontend && npm run build` -- static export succeeds, produces `frontend/out/index.html`
3. Verify all new files exist: price-store.ts (modified), watchlist-store.ts (new), globals.css (modified), Sparkline.tsx (new), PriceCell.tsx (new), WatchlistPanel.tsx (replaced), page.tsx (modified)
4. Grep for key patterns:
   - `priceHistory` in price-store.ts
   - `useWatchlistStore` in watchlist-store.ts
   - `flash-up` in globals.css
   - `polyline` in Sparkline.tsx
   - `animate-flash` in PriceCell.tsx
   - `fetchWatchlist` in page.tsx
</verification>

<success_criteria>
- Watchlist panel displays ticker symbols with price, change%, direction, and sparkline for each row
- Flash CSS animations defined and applied on price direction changes via React key remounting
- Sparkline SVG renders from accumulated priceHistory data
- Clicking a ticker row selects it with visual highlight
- Add ticker input and remove button provide watchlist CRUD
- Frontend builds to static export without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-watchlist-price-display/07-01-SUMMARY.md`
</output>
