---
phase: 08-portfolio-visualizations-trading
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/stores/portfolio-store.ts
  - frontend/src/components/portfolio/Heatmap.tsx
  - frontend/src/components/portfolio/PnlChart.tsx
autonomous: true

must_haves:
  truths:
    - "Portfolio store holds positions array, snapshots array, tradeLoading, tradeError, fetchHistory, and executeTrade"
    - "Heatmap renders a Recharts Treemap with positions sized by market_value and colored green-to-red by P&L percent"
    - "P&L chart renders a lightweight-charts AreaSeries showing portfolio value over time from snapshot data"
  artifacts:
    - path: "frontend/src/stores/portfolio-store.ts"
      provides: "Extended portfolio store with positions, snapshots, trade execution, and history fetch"
      contains: "executeTrade"
    - path: "frontend/src/components/portfolio/Heatmap.tsx"
      provides: "Recharts Treemap with custom P&L-colored content renderer"
      contains: "Treemap"
    - path: "frontend/src/components/portfolio/PnlChart.tsx"
      provides: "lightweight-charts AreaSeries for portfolio value over time"
      contains: "AreaSeries"
  key_links:
    - from: "frontend/src/stores/portfolio-store.ts"
      to: "/api/portfolio"
      via: "fetch in fetchPortfolio"
      pattern: "fetch.*api/portfolio"
    - from: "frontend/src/stores/portfolio-store.ts"
      to: "/api/portfolio/history"
      via: "fetch in fetchHistory"
      pattern: "fetch.*api/portfolio/history"
    - from: "frontend/src/stores/portfolio-store.ts"
      to: "/api/portfolio/trade"
      via: "fetch in executeTrade"
      pattern: "fetch.*api/portfolio/trade"
---

<objective>
Install Recharts, extend the portfolio Zustand store with positions/snapshots/trade execution, and create the two chart visualization components (heatmap treemap and P&L area chart).

Purpose: Provides the data layer and visualization components needed for portfolio display. The store extension is the foundation for all Phase 8 UI components.
Output: Extended portfolio-store.ts, Heatmap.tsx, PnlChart.tsx, recharts installed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-portfolio-visualizations-trading/08-RESEARCH.md

@frontend/src/stores/portfolio-store.ts
@frontend/src/components/panels/ChartPanel.tsx
@frontend/src/app/globals.css
@backend/app/portfolio/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts and extend portfolio store</name>
  <files>
    frontend/package.json
    frontend/src/stores/portfolio-store.ts
  </files>
  <action>
Install recharts: `cd frontend && npm install recharts`

Rewrite `frontend/src/stores/portfolio-store.ts` to extend the store interface. The backend API response shapes are defined in `backend/app/portfolio/models.py`.

Add these types (defined at module level, NOT exported separately -- used only by the store):

```ts
interface Position {
  ticker: string;
  quantity: number;
  avg_cost: number;
  current_price: number;
  market_value: number;
  unrealized_pnl: number;
  unrealized_pnl_percent: number;
}

interface Snapshot {
  total_value: number;
  recorded_at: string;
}
```

Extend PortfolioStore interface to add:
- `positions: Position[]`
- `snapshots: Snapshot[]`
- `tradeLoading: boolean`
- `tradeError: string | null`
- `fetchHistory: () => Promise<void>`
- `executeTrade: (ticker: string, side: "buy" | "sell", quantity: number) => Promise<void>`

Implementation details:

`fetchPortfolio` -- update to also store `positions` from `data.positions` (the API already returns this array).

`fetchHistory` -- fetch GET `/api/portfolio/history`, parse response, set `snapshots` from `data.snapshots`.

`executeTrade` -- POST to `/api/portfolio/trade` with `{ticker, side, quantity}`. On start: set `tradeError: null, tradeLoading: true`. On success (res.ok): set `tradeLoading: false`, then call `get().fetchPortfolio()` and `get().fetchHistory()` to refresh. On HTTP error (!res.ok): parse `err.detail` from the JSON response body and set `tradeError` and `tradeLoading: false`. On network error (catch): set `tradeError: "Trade failed"` and `tradeLoading: false`.

Export Position and Snapshot types (they are needed by visualization components).

Keep the `create<PortfolioStore>()((set, get) => ({...}))` Zustand pattern already used in the codebase.
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to confirm no TypeScript errors.
Verify `recharts` appears in `frontend/package.json` dependencies.
  </verify>
  <done>
Portfolio store has positions[], snapshots[], tradeLoading, tradeError, fetchHistory(), executeTrade(). Recharts is installed. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Heatmap and PnlChart components</name>
  <files>
    frontend/src/components/portfolio/Heatmap.tsx
    frontend/src/components/portfolio/PnlChart.tsx
  </files>
  <action>
Create directory `frontend/src/components/portfolio/` if it does not exist.

**Heatmap.tsx** -- Recharts Treemap with custom P&L-colored cells.

Component: `Heatmap` accepting `{ positions: Position[] }` prop (import Position from portfolio-store).

Data mapping: Transform positions to `{ name: ticker, size: market_value, pnlPercent: unrealized_pnl_percent, pnl: unrealized_pnl }`. Filter to `market_value > 0` before passing to Treemap.

P&L color function: Linear RGB interpolation from red (#ef4444 at -10%) through neutral (#484f58 at 0%) to green (#22c55e at +10%). Clamp pnlPercent to [-10, +10] range.

```tsx
function pnlColor(pnlPercent: number): string {
  const clamped = Math.max(-10, Math.min(10, pnlPercent));
  const t = (clamped + 10) / 20; // 0 = red, 0.5 = neutral, 1 = green
  let r: number, g: number, b: number;
  if (t < 0.5) {
    const s = t / 0.5;
    r = Math.round(239 + s * (72 - 239));
    g = Math.round(68 + s * (79 - 68));
    b = Math.round(68 + s * (88 - 68));
  } else {
    const s = (t - 0.5) / 0.5;
    r = Math.round(72 + s * (34 - 72));
    g = Math.round(79 + s * (197 - 79));
    b = Math.round(88 + s * (94 - 88));
  }
  return `rgb(${r},${g},${b})`;
}
```

Custom content renderer using Recharts v3 `content` prop (NOT Cell component which is deprecated in v3):

```tsx
function CustomContent(props: any) {
  const { x, y, width, height, name, pnlPercent, pnl } = props;
  if (width < 2 || height < 2) return null;
  return (
    <g>
      <rect x={x} y={y} width={width} height={height}
        fill={pnlColor(pnlPercent)} stroke="#2d2d44" strokeWidth={1} />
      {width > 40 && height > 30 && (
        <>
          <text x={x + width / 2} y={y + height / 2 - 6}
            textAnchor="middle" fill="#e6edf3" fontSize={12} fontFamily="JetBrains Mono, monospace">
            {name}
          </text>
          <text x={x + width / 2} y={y + height / 2 + 10}
            textAnchor="middle" fill="#e6edf3" fontSize={10} fontFamily="JetBrains Mono, monospace">
            {pnl >= 0 ? '+' : ''}{pnl.toFixed(2)}%
          </text>
        </>
      )}
    </g>
  );
}
```

In the component JSX, wrap in `ResponsiveContainer` with `width="100%" height="100%"`. Use `<Treemap data={data} dataKey="size" content={<CustomContent />} isAnimationActive={false} />`.

Empty state: When no positions with market_value > 0 exist, show centered text "No positions" in text-text-muted font-mono text-xs.

Mark component "use client".

**PnlChart.tsx** -- lightweight-charts v5 AreaSeries for portfolio value over time.

Component: `PnlChart` accepting `{ snapshots: Snapshot[] }` prop (import Snapshot from portfolio-store).

Follow the EXACT same pattern as `ChartPanel.tsx`:
- `containerRef` for the chart container div
- `chartRef` and `seriesRef` refs
- First `useEffect` (empty deps) creates the chart with `createChart()` using same terminal colors:
  - background: `#1a1a2e`, textColor: `#8b949e`
  - grid vertLines/horzLines: `#2d2d44`
  - timeScale borderColor: `#2d2d44`, timeVisible: true
  - rightPriceScale borderColor: `#2d2d44`
- Add series with `chart.addSeries(AreaSeries, { lineColor: "#ecad0a", topColor: "rgba(236, 173, 10, 0.4)", bottomColor: "rgba(236, 173, 10, 0.05)", lineWidth: 2 })` -- accent yellow color.
- ResizeObserver on containerRef for responsive sizing.
- Cleanup: observer.disconnect() + chart.remove().

Second `useEffect` (deps: [snapshots]) syncs data:
- If no seriesRef or empty snapshots, return.
- Map snapshots to `{ time: (new Date(s.recorded_at).getTime() / 1000) as UTCTimestamp, value: s.total_value }`.
- Call `seriesRef.current.setData(mapped)` then `chartRef.current.timeScale().fitContent()`.

Empty state: When snapshots is empty, show centered text "No P&L data" in text-text-muted font-mono text-xs. Return early BEFORE the chart container div (so the chart useEffect only runs when we have data). Actually, it is simpler to always render the container but show an overlay message when empty. Use the same pattern as ChartPanel -- always render the container, but the data sync useEffect handles the empty case by just not setting data.

Container layout: `h-full w-full flex flex-col`. A small header "P&L" in text-text-muted font-mono text-xs uppercase. Then `div ref={containerRef} className="flex-1 min-h-0"` for the chart.

Mark component "use client".

Import types from lightweight-charts: `createChart, AreaSeries, ColorType` and types `IChartApi, ISeriesApi, UTCTimestamp`.
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to confirm no TypeScript errors.
Verify both files exist: `ls frontend/src/components/portfolio/Heatmap.tsx frontend/src/components/portfolio/PnlChart.tsx`
  </verify>
  <done>
Heatmap.tsx renders a Recharts Treemap with P&L-colored cells using the content prop. PnlChart.tsx renders a lightweight-charts AreaSeries in accent yellow with snapshot data. Both handle empty state gracefully. TypeScript compiles.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes with no errors
2. `recharts` is listed in frontend/package.json dependencies
3. portfolio-store.ts exports Position and Snapshot types and has executeTrade, fetchHistory actions
4. Heatmap.tsx uses Recharts Treemap with `content` prop (not deprecated Cell)
5. PnlChart.tsx uses lightweight-charts v5 `addSeries(AreaSeries)` pattern matching ChartPanel.tsx
</verification>

<success_criteria>
- Portfolio store extended with positions, snapshots, trade execution, and history fetching
- Heatmap component renders treemap with P&L coloring from position data
- P&L chart component renders area chart with portfolio value snapshots
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-portfolio-visualizations-trading/08-01-SUMMARY.md`
</output>
