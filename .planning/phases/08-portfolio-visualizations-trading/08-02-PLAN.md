---
phase: 08-portfolio-visualizations-trading
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - frontend/src/components/portfolio/PositionsTable.tsx
  - frontend/src/components/portfolio/TradeBar.tsx
  - frontend/src/components/panels/PortfolioPanel.tsx
  - frontend/src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "Positions table displays all holdings with ticker, quantity, avg cost, current price, unrealized P&L, and % change"
    - "Trade bar has ticker input, quantity input, buy button, sell button, and inline error display"
    - "Executing a trade updates the portfolio immediately without a confirmation dialog"
    - "Trade bar ticker pre-fills from the selected watchlist ticker"
    - "Portfolio heatmap and P&L chart are visible in the PortfolioPanel grid cell"
    - "Positions table and trade bar are visible in the adjacent grid cell"
  artifacts:
    - path: "frontend/src/components/portfolio/PositionsTable.tsx"
      provides: "Table of all holdings with P&L data"
      contains: "PositionsTable"
    - path: "frontend/src/components/portfolio/TradeBar.tsx"
      provides: "Trade input form with buy/sell buttons and inline errors"
      contains: "TradeBar"
    - path: "frontend/src/components/panels/PortfolioPanel.tsx"
      provides: "Container with Heatmap and PnlChart stacked vertically"
      contains: "Heatmap"
    - path: "frontend/src/app/page.tsx"
      provides: "Grid wiring with PositionsTable, TradeBar, and fetchHistory on mount"
      contains: "PositionsTable"
  key_links:
    - from: "frontend/src/components/portfolio/TradeBar.tsx"
      to: "frontend/src/stores/portfolio-store.ts"
      via: "usePortfolioStore executeTrade selector"
      pattern: "usePortfolioStore.*executeTrade"
    - from: "frontend/src/components/portfolio/TradeBar.tsx"
      to: "frontend/src/stores/watchlist-store.ts"
      via: "useWatchlistStore selectedTicker selector for pre-fill"
      pattern: "useWatchlistStore.*selectedTicker"
    - from: "frontend/src/app/page.tsx"
      to: "frontend/src/stores/portfolio-store.ts"
      via: "fetchHistory called on mount"
      pattern: "fetchHistory"
---

<objective>
Create the positions table and trade bar components, then wire all Phase 8 components into the existing grid layout.

Purpose: Completes the portfolio visualization and trading UI. Users can see positions, execute trades, and view portfolio charts -- all updating in real time.
Output: PositionsTable.tsx, TradeBar.tsx, updated PortfolioPanel.tsx, updated page.tsx.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-portfolio-visualizations-trading/08-RESEARCH.md
@.planning/phases/08-portfolio-visualizations-trading/08-01-SUMMARY.md

@frontend/src/stores/portfolio-store.ts
@frontend/src/stores/watchlist-store.ts
@frontend/src/components/panels/PortfolioPanel.tsx
@frontend/src/components/panels/WatchlistPanel.tsx
@frontend/src/app/page.tsx
@frontend/src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PositionsTable and TradeBar components</name>
  <files>
    frontend/src/components/portfolio/PositionsTable.tsx
    frontend/src/components/portfolio/TradeBar.tsx
  </files>
  <action>
**PositionsTable.tsx** -- Table of all holdings with P&L data.

"use client" component. Accept `{ positions: Position[] }` prop (import Position from portfolio-store).

Empty state: If positions.length === 0, render centered text "No positions" in text-text-muted font-mono text-xs.

Table layout: `overflow-y-auto` wrapper. Inside, a `<table className="w-full font-mono text-xs">`.

Table header row with columns: Ticker, Qty, Avg Cost, Price, P&L, %. All `text-text-muted uppercase tracking-wider`. Ticker left-aligned, all others right-aligned. Use `py-1 px-2` padding.

Table body: Map over positions. Each row has `border-t border-terminal-border`. Cells:
- Ticker: `text-text-primary font-bold`, left-aligned
- Qty: `text-text-secondary`, right-aligned, display `p.quantity`
- Avg Cost: `text-text-secondary`, right-aligned, format as `$XX.XX`
- Price: `text-text-primary`, right-aligned, format as `$XX.XX`
- P&L: conditional color -- `text-price-up` if >= 0, `text-price-down` if < 0. Format as `+$XX.XX` or `-$XX.XX`. Right-aligned.
- %: same conditional color. Format as `+X.XX%` or `-X.XX%`. Right-aligned.

Use `Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' })` for currency formatting (matching the Header.tsx pattern from Phase 6).

**TradeBar.tsx** -- Trade input form with buy/sell and inline errors.

"use client" component. No props -- reads from stores directly.

State: `const [ticker, setTicker] = useState("")` and `const [quantity, setQuantity] = useState("")`.

Store selectors:
- `const executeTrade = usePortfolioStore((s) => s.executeTrade)`
- `const tradeError = usePortfolioStore((s) => s.tradeError)`
- `const tradeLoading = usePortfolioStore((s) => s.tradeLoading)`
- `const selectedTicker = useWatchlistStore((s) => s.selectedTicker)`

Pre-fill ticker from selectedTicker: Use a `useEffect` with `[selectedTicker]` dependency that sets `setTicker(selectedTicker ?? "")` when selectedTicker changes.

`handleTrade(side)` function:
- Parse quantity as `parseFloat(quantity)`.
- If `!ticker.trim() || isNaN(qty) || qty <= 0` return early (no action).
- Call `executeTrade(ticker.toUpperCase().trim(), side, qty)`.
- On success (no error after executeTrade resolves), clear the quantity field: `setQuantity("")`.

Layout: `p-2 border-t border-terminal-border` wrapper.

Row of inputs and buttons using `flex items-center gap-1`:
- Ticker input: `bg-terminal-bg border border-terminal-border rounded px-2 py-1 font-mono text-xs text-text-primary placeholder:text-text-muted focus:outline-none focus:border-brand-blue w-20`. Value bound to `ticker`, onChange uppercases. Placeholder "TICKER".
- Quantity input: Same styling but `w-16`, type="number", placeholder "QTY". Step="any" for fractional shares.
- BUY button: `bg-price-up/20 text-price-up border border-price-up/30 rounded px-2 py-1 font-mono text-xs font-bold hover:bg-price-up/30 transition-colors disabled:opacity-50`. onClick calls `handleTrade("buy")`. Disabled when tradeLoading.
- SELL button: `bg-price-down/20 text-price-down border border-price-down/30 rounded px-2 py-1 font-mono text-xs font-bold hover:bg-price-down/30 transition-colors disabled:opacity-50`. onClick calls `handleTrade("sell")`. Disabled when tradeLoading.

Error display: Below the input row, if `tradeError` is truthy, show `<p className="text-price-down text-xs font-mono mt-1">{tradeError}</p>`.
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to confirm no TypeScript errors.
Verify both files exist: `ls frontend/src/components/portfolio/PositionsTable.tsx frontend/src/components/portfolio/TradeBar.tsx`
  </verify>
  <done>
PositionsTable shows all holdings with correct formatting and P&L colors. TradeBar has ticker (pre-filled from selected), quantity, buy/sell buttons, and inline error display. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire components into PortfolioPanel and page layout</name>
  <files>
    frontend/src/components/panels/PortfolioPanel.tsx
    frontend/src/app/page.tsx
  </files>
  <action>
**PortfolioPanel.tsx** -- Replace placeholder with Heatmap + PnlChart stacked vertically.

Rewrite the entire component. "use client". Import:
- `usePortfolioStore` from portfolio-store
- `Heatmap` from `@/components/portfolio/Heatmap`
- `PnlChart` from `@/components/portfolio/PnlChart`

Zustand selectors: `positions` and `snapshots` from portfolio store (separate selectors per Zustand convention).

Layout: `h-full w-full flex flex-col bg-terminal-surface`.

Top section header: `px-3 pt-3 pb-1` with "Portfolio" in text-text-muted font-mono text-xs uppercase tracking-wider.

Split remaining space into two halves vertically using `flex-1 flex flex-col min-h-0`:
- Top half: `flex-1 min-h-0 px-1` containing `<Heatmap positions={positions} />`
- Bottom half: `flex-1 min-h-0` containing `<PnlChart snapshots={snapshots} />`

**page.tsx** -- Wire positions panel and add fetchHistory to mount.

Replace the "Positions" placeholder div with a proper component layout:
```tsx
<div className="col-span-3 bg-terminal-surface flex flex-col">
  <div className="flex-1 min-h-0 overflow-hidden">
    <PositionsPanel />
  </div>
</div>
```

Create a new inline `PositionsPanel` component within page.tsx (or as a separate small component -- inline is fine for simplicity since it just combines PositionsTable + TradeBar). Actually, for cleanliness, import PositionsTable and TradeBar directly and compose in the grid cell:

```tsx
<div className="col-span-3 bg-terminal-surface flex flex-col">
  <div className="px-3 pt-3 pb-1">
    <span className="text-text-muted font-mono text-xs uppercase tracking-wider">
      Positions
    </span>
  </div>
  <div className="flex-1 min-h-0 overflow-y-auto">
    <PositionsTable positions={positions} />
  </div>
  <TradeBar />
</div>
```

For positions data, add a selector in the Home component: `const positions = usePortfolioStore((s) => s.positions)`.

Add imports for PositionsTable from `@/components/portfolio/PositionsTable` and TradeBar from `@/components/portfolio/TradeBar`.

Add `fetchHistory` to the mount effect:
- Get `const fetchHistory = usePortfolioStore((s) => s.fetchHistory)` selector.
- In the existing useEffect, add `fetchHistory()` alongside `fetchPortfolio()` and `fetchWatchlist()`.
- Add `fetchHistory` to the dependency array.
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` to confirm no TypeScript errors.
Run `cd frontend && npm run build` to verify the static export builds successfully.
  </verify>
  <done>
PortfolioPanel shows Heatmap (top) and PnlChart (bottom). Page grid cell shows PositionsTable with TradeBar below it. fetchHistory runs on mount. The full build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` succeeds (full static export)
2. PortfolioPanel contains Heatmap and PnlChart components
3. Positions grid cell contains PositionsTable and TradeBar
4. TradeBar pre-fills ticker from selectedTicker in watchlist store
5. fetchHistory is called on mount in page.tsx
6. Trade errors display inline below the trade bar
7. Empty states render gracefully for both heatmap and positions table
</verification>

<success_criteria>
- Portfolio heatmap renders as a treemap sized by weight and colored by P&L
- P&L line chart shows portfolio value over time from snapshot data
- Positions table displays ticker, quantity, avg cost, current price, unrealized P&L, and % change
- Trade bar allows entering ticker and quantity, clicking buy or sell, with no confirmation dialog
- Trade validation errors display inline
- Frontend builds successfully as a static export
</success_criteria>

<output>
After completion, create `.planning/phases/08-portfolio-visualizations-trading/08-02-SUMMARY.md`
</output>
