---
phase: 10-packaging-testing
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - test/package.json
  - test/playwright.config.ts
  - test/tsconfig.json
  - test/tests/fresh-start.spec.ts
  - test/tests/watchlist.spec.ts
  - test/tests/trading.spec.ts
  - test/tests/portfolio.spec.ts
  - test/tests/chat.spec.ts
  - test/docker-compose.test.yml
autonomous: false

must_haves:
  truths:
    - "Fresh start shows default watchlist with 10 tickers, $10,000 balance, and streaming prices"
    - "User can add and remove a ticker from the watchlist"
    - "Buying shares reduces cash and creates a position in the positions table"
    - "Selling shares increases cash and updates the position"
    - "Portfolio visualizations render (heatmap, P&L chart) after trading"
    - "AI chat (mocked) returns a response with inline action cards"
  artifacts:
    - path: "test/package.json"
      provides: "Playwright test project dependencies"
      contains: "@playwright/test"
    - path: "test/playwright.config.ts"
      provides: "Playwright configuration with baseURL from env"
      contains: "baseURL"
    - path: "test/tests/fresh-start.spec.ts"
      provides: "Fresh start E2E test"
      contains: "AAPL"
    - path: "test/tests/watchlist.spec.ts"
      provides: "Watchlist CRUD E2E tests"
      contains: "add.*ticker"
    - path: "test/tests/trading.spec.ts"
      provides: "Buy/sell trade E2E tests"
      contains: "BUY"
    - path: "test/tests/portfolio.spec.ts"
      provides: "Portfolio update E2E tests"
      contains: "position"
    - path: "test/tests/chat.spec.ts"
      provides: "AI chat mock E2E tests"
      contains: "Send"
    - path: "test/docker-compose.test.yml"
      provides: "Test infrastructure with app + Playwright containers"
      contains: "LLM_MOCK=true"
  key_links:
    - from: "test/playwright.config.ts"
      to: "http://localhost:8000"
      via: "baseURL env var"
      pattern: "BASE_URL.*localhost:8000"
    - from: "test/tests/trading.spec.ts"
      to: "frontend/src/components/portfolio/TradeBar.tsx"
      via: "placeholder selectors: TICKER, QTY, BUY, SELL"
      pattern: "getByPlaceholder|getByRole"
    - from: "test/tests/chat.spec.ts"
      to: "frontend/src/components/panels/ChatPanel.tsx"
      via: "placeholder: Ask FinAlly, button: Send"
      pattern: "Ask FinAlly|Send"
    - from: "test/docker-compose.test.yml"
      to: "Dockerfile"
      via: "build: .."
      pattern: "build:.*\\.\\."
---

<objective>
Create the Playwright E2E test suite and docker-compose.test.yml infrastructure. Tests run against the Docker container with LLM_MOCK=true, covering fresh start, watchlist CRUD, buy/sell trades, portfolio updates, and AI chat.

Purpose: This fulfills TEST-01, TEST-02, TEST-03 requirements -- validating the full application works end-to-end inside Docker.
Output: Complete test/ directory with Playwright project, 5 test spec files, and docker-compose.test.yml.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-packaging-testing/10-RESEARCH.md
@.planning/phases/10-packaging-testing/10-01-SUMMARY.md

@frontend/src/components/panels/WatchlistPanel.tsx
@frontend/src/components/portfolio/TradeBar.tsx
@frontend/src/components/portfolio/PositionsTable.tsx
@frontend/src/components/panels/ChatPanel.tsx
@frontend/src/components/layout/Header.tsx
@frontend/src/components/ui/ConnectionDot.tsx
@frontend/src/components/ui/PriceCell.tsx
@backend/app/llm/mock.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Playwright project setup and all E2E test specs</name>
  <files>test/package.json, test/playwright.config.ts, test/tsconfig.json, test/tests/fresh-start.spec.ts, test/tests/watchlist.spec.ts, test/tests/trading.spec.ts, test/tests/portfolio.spec.ts, test/tests/chat.spec.ts</files>
  <action>
First, delete the existing test/node_modules directory (leftover from prior work with no package.json).

Create test/package.json:
```json
{
  "name": "finally-e2e",
  "private": true,
  "scripts": {
    "test": "playwright test",
    "test:headed": "playwright test --headed"
  },
  "devDependencies": {
    "@playwright/test": "1.50.1"
  }
}
```

NOTE on Playwright version: Use 1.50.1 (latest stable release matching the mcr.microsoft.com/playwright Docker images available). Verify the exact latest version by checking npm before installing. The Docker image tag in docker-compose.test.yml must match this version exactly.

Create test/tsconfig.json:
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true
  },
  "include": ["tests/**/*.ts", "playwright.config.ts"]
}
```

Create test/playwright.config.ts:
```typescript
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests',
  timeout: 30000,
  expect: { timeout: 10000 },
  retries: 1,
  reporter: [['list'], ['html', { open: 'never' }]],
  use: {
    baseURL: process.env.BASE_URL || 'http://localhost:8000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
});
```

Run `cd /Users/ed/projects/finally/test && npm install` to install dependencies.

Create test/tests/fresh-start.spec.ts:
```typescript
import { test, expect } from '@playwright/test';

test.describe('Fresh Start', () => {
  test('shows default watchlist tickers', async ({ page }) => {
    await page.goto('/');

    // Default watchlist should show all 10 tickers
    const defaultTickers = ['AAPL', 'GOOGL', 'MSFT', 'AMZN', 'TSLA', 'NVDA', 'META', 'JPM', 'V', 'NFLX'];
    for (const ticker of defaultTickers) {
      await expect(page.getByText(ticker, { exact: true }).first()).toBeVisible({ timeout: 15000 });
    }
  });

  test('shows starting cash balance of $10,000', async ({ page }) => {
    await page.goto('/');

    // Header should show $10,000.00 cash balance
    await expect(page.getByText('$10,000.00')).toBeVisible({ timeout: 10000 });
  });

  test('prices start streaming from SSE', async ({ page }) => {
    await page.goto('/');

    // Wait for the connection status to show "connected"
    await expect(page.getByText('connected')).toBeVisible({ timeout: 15000 });
  });

  test('connection status indicator is visible', async ({ page }) => {
    await page.goto('/');

    // The ConnectionDot component renders the connection status text
    await expect(page.getByText('connected')).toBeVisible({ timeout: 15000 });
  });
});
```

Create test/tests/watchlist.spec.ts:
```typescript
import { test, expect } from '@playwright/test';

test.describe('Watchlist CRUD', () => {
  test('add a new ticker to watchlist', async ({ page }) => {
    await page.goto('/');

    // Wait for initial watchlist to load
    await expect(page.getByText('AAPL', { exact: true }).first()).toBeVisible({ timeout: 15000 });

    // The watchlist add input has placeholder "TICKER"
    // There are two inputs with placeholder TICKER (watchlist and trade bar)
    // The watchlist one is in the WatchlistPanel at the top, paired with a "+" button
    const addInput = page.locator('input[placeholder="TICKER"]').first();
    await addInput.fill('PYPL');
    await addInput.press('Enter');

    // PYPL should appear in the watchlist
    await expect(page.getByText('PYPL', { exact: true }).first()).toBeVisible({ timeout: 10000 });
  });

  test('remove a ticker from watchlist', async ({ page }) => {
    await page.goto('/');

    // Wait for initial load
    await expect(page.getByText('NFLX', { exact: true }).first()).toBeVisible({ timeout: 15000 });

    // Scope to the container div that holds the NFLX PriceCell
    const nflxCell = page.locator('div', { has: page.getByText('NFLX', { exact: true }) }).first();
    await nflxCell.hover();

    // Click the "x" remove button within that scoped container
    const removeButton = nflxCell.locator('button', { hasText: 'x' });
    await removeButton.click({ force: true });

    // NFLX should no longer be visible (give it time to disappear)
    await expect(page.getByText('NFLX', { exact: true })).not.toBeVisible({ timeout: 10000 });
  });
});
```

Create test/tests/trading.spec.ts:
```typescript
import { test, expect } from '@playwright/test';

test.describe('Trading', () => {
  test('buy shares reduces cash and creates position', async ({ page }) => {
    await page.goto('/');

    // Wait for prices to load so we can trade
    await expect(page.getByText('connected')).toBeVisible({ timeout: 15000 });
    // Wait a moment for portfolio data to load
    await expect(page.getByText('$10,000.00')).toBeVisible({ timeout: 10000 });

    // The TradeBar has: TICKER input, QTY input, BUY button, SELL button
    // TradeBar's ticker input is the second TICKER placeholder (first is watchlist)
    const tradeInputs = page.locator('input[placeholder="TICKER"]');
    const tickerInput = tradeInputs.nth(1);
    const qtyInput = page.locator('input[placeholder="QTY"]');
    const buyButton = page.getByRole('button', { name: 'BUY' });

    await tickerInput.fill('AAPL');
    await qtyInput.fill('10');
    await buyButton.click();

    // Cash should decrease from $10,000.00 (AAPL is ~$190-$250 simulated, so 10 shares = ~$1900-$2500)
    // Wait for the cash to update - it should no longer be $10,000.00
    await expect(page.getByText('$10,000.00')).not.toBeVisible({ timeout: 10000 });

    // Position should appear in the positions table
    // PositionsTable renders ticker names in bold cells
    const positionsArea = page.locator('table');
    await expect(positionsArea.getByText('AAPL')).toBeVisible({ timeout: 5000 });
  });

  test('sell shares increases cash and updates position', async ({ page }) => {
    await page.goto('/');

    // Wait for prices and portfolio
    await expect(page.getByText('connected')).toBeVisible({ timeout: 15000 });
    await expect(page.getByText('$10,000.00')).toBeVisible({ timeout: 10000 });

    const tradeInputs = page.locator('input[placeholder="TICKER"]');
    const tickerInput = tradeInputs.nth(1);
    const qtyInput = page.locator('input[placeholder="QTY"]');
    const buyButton = page.getByRole('button', { name: 'BUY' });
    const sellButton = page.getByRole('button', { name: 'SELL' });

    // First buy some shares
    await tickerInput.fill('AAPL');
    await qtyInput.fill('10');
    await buyButton.click();

    // Wait for position to appear
    const positionsTable = page.locator('table');
    await expect(positionsTable.getByText('AAPL')).toBeVisible({ timeout: 10000 });

    // Now sell 5 shares
    await tickerInput.fill('AAPL');
    await qtyInput.fill('5');
    await sellButton.click();

    // The position should still exist with quantity 5
    // Locate the AAPL row specifically and check the Qty column (2nd cell)
    const aaplRow = positionsTable.locator('tr', { has: page.getByText('AAPL') });
    await expect(aaplRow.locator('td').nth(1)).toHaveText('5', { timeout: 10000 });
  });

  test('sell more than owned shows error', async ({ page }) => {
    await page.goto('/');

    await expect(page.getByText('connected')).toBeVisible({ timeout: 15000 });

    const tradeInputs = page.locator('input[placeholder="TICKER"]');
    const tickerInput = tradeInputs.nth(1);
    const qtyInput = page.locator('input[placeholder="QTY"]');
    const sellButton = page.getByRole('button', { name: 'SELL' });

    // Try to sell shares we don't own
    await tickerInput.fill('AAPL');
    await qtyInput.fill('100');
    await sellButton.click();

    // Should show a trade error message (rendered as <p> with text-price-down class)
    await expect(page.locator('p').filter({ hasText: /insufficient|not enough|no position/i })).toBeVisible({ timeout: 5000 });
  });
});
```

Create test/tests/portfolio.spec.ts:
```typescript
import { test, expect } from '@playwright/test';

test.describe('Portfolio Updates', () => {
  test('portfolio value updates after trade', async ({ page }) => {
    await page.goto('/');

    // Wait for initial state
    await expect(page.getByText('$10,000.00')).toBeVisible({ timeout: 10000 });

    // Execute a buy trade
    const tradeInputs = page.locator('input[placeholder="TICKER"]');
    const tickerInput = tradeInputs.nth(1);
    const qtyInput = page.locator('input[placeholder="QTY"]');
    const buyButton = page.getByRole('button', { name: 'BUY' });

    await tickerInput.fill('AAPL');
    await qtyInput.fill('5');
    await buyButton.click();

    // Cash should decrease
    await expect(page.getByText('$10,000.00')).not.toBeVisible({ timeout: 10000 });
  });

  test('positions table shows correct columns', async ({ page }) => {
    await page.goto('/');

    // Wait for load
    await expect(page.getByText('connected')).toBeVisible({ timeout: 15000 });

    // Buy shares to create a position
    const tradeInputs = page.locator('input[placeholder="TICKER"]');
    const tickerInput = tradeInputs.nth(1);
    const qtyInput = page.locator('input[placeholder="QTY"]');
    const buyButton = page.getByRole('button', { name: 'BUY' });

    await tickerInput.fill('MSFT');
    await qtyInput.fill('3');
    await buyButton.click();

    // Positions table should have column headers
    const table = page.locator('table');
    await expect(table).toBeVisible({ timeout: 10000 });
    await expect(table.getByText('Ticker')).toBeVisible();
    await expect(table.getByText('Qty')).toBeVisible();
    await expect(table.getByText('Avg Cost')).toBeVisible();
    await expect(table.getByText('Price')).toBeVisible();
    await expect(table.getByText('P&L')).toBeVisible();

    // MSFT should appear in the table
    await expect(table.getByText('MSFT')).toBeVisible();
  });
});
```

Create test/tests/chat.spec.ts:
```typescript
import { test, expect } from '@playwright/test';

test.describe('AI Chat (Mocked)', () => {
  test('send a message and receive a response', async ({ page }) => {
    await page.goto('/');

    // Wait for app to load
    await expect(page.getByText('connected')).toBeVisible({ timeout: 15000 });

    // The ChatPanel has placeholder "Ask FinAlly..." and a "Send" button
    const chatInput = page.getByPlaceholder('Ask FinAlly...');
    const sendButton = page.getByRole('button', { name: 'Send' });

    // If chat panel is collapsed, open it by clicking the "AI Chat" text
    const chatInputVisible = await chatInput.isVisible();
    if (!chatInputVisible) {
      await page.getByText('AI Chat').click();
      await expect(chatInput).toBeVisible({ timeout: 5000 });
    }

    // Send a generic message (should trigger "default" mock response)
    await chatInput.fill('What is my portfolio worth?');
    await sendButton.click();

    // Mock response: "I can see your portfolio. You have cash available. How can I help?"
    await expect(page.getByText('I can see your portfolio')).toBeVisible({ timeout: 15000 });
  });

  test('chat buy command triggers trade action card', async ({ page }) => {
    await page.goto('/');

    await expect(page.getByText('connected')).toBeVisible({ timeout: 15000 });

    const chatInput = page.getByPlaceholder('Ask FinAlly...');
    const sendButton = page.getByRole('button', { name: 'Send' });

    const chatInputVisible = await chatInput.isVisible();
    if (!chatInputVisible) {
      await page.getByText('AI Chat').click();
      await expect(chatInput).toBeVisible({ timeout: 5000 });
    }

    // Send a "buy" message -- mock.py returns a buy 5 AAPL trade
    await chatInput.fill('Please buy some AAPL');
    await sendButton.click();

    // Mock response: "Done! I've bought 5 shares of AAPL for you."
    await expect(page.getByText("I've bought 5 shares of AAPL")).toBeVisible({ timeout: 15000 });

    // Should also show a trade action card with "BUY" text
    await expect(page.getByText('BUY').last()).toBeVisible({ timeout: 5000 });
  });

  test('chat add watchlist command shows watchlist action card', async ({ page }) => {
    await page.goto('/');

    await expect(page.getByText('connected')).toBeVisible({ timeout: 15000 });

    const chatInput = page.getByPlaceholder('Ask FinAlly...');
    const sendButton = page.getByRole('button', { name: 'Send' });

    const chatInputVisible = await chatInput.isVisible();
    if (!chatInputVisible) {
      await page.getByText('AI Chat').click();
      await expect(chatInput).toBeVisible({ timeout: 5000 });
    }

    // Send an "add" message -- mock.py returns watchlist add PYPL
    await chatInput.fill('Add PYPL to my watchlist');
    await sendButton.click();

    // Mock response: "I've added PYPL to your watchlist."
    await expect(page.getByText("added PYPL to your watchlist")).toBeVisible({ timeout: 15000 });

    // The WatchlistCard shows "+ PYPL added to watchlist"
    await expect(page.getByText('PYPL').first()).toBeVisible({ timeout: 5000 });
  });
});
```

**Selector rationale based on actual frontend components:**
- WatchlistPanel: input placeholder="TICKER", button text "+"
- TradeBar: input placeholder="TICKER" (second one on page), input placeholder="QTY", buttons "BUY"/"SELL"
- ChatPanel: input placeholder="Ask FinAlly...", button text "Send"
- ConnectionDot: text "connected"/"connecting"/"disconnected"
- Header: text "$10,000.00" for initial cash
- PositionsTable: standard table element with column headers "Ticker", "Qty", "Avg Cost", "Price", "P&L"
- PriceCell remove button: button with text "x" (opacity-0 by default, visible on hover)
- Mock LLM responses from backend/app/llm/mock.py: keyword matching on "buy", "sell", "add", "remove"
  </action>
  <verify>
Run: cd /Users/ed/projects/finally/test && npx playwright test --list (should list all test specs without errors)
The actual test execution requires the Docker container running with LLM_MOCK=true, which will be verified in the checkpoint task.
  </verify>
  <done>
Playwright project initialized with package.json, config, and tsconfig. Five test spec files exist covering all required scenarios: fresh-start (default tickers, cash, SSE), watchlist (add/remove), trading (buy/sell/error), portfolio (value updates, table columns), chat (send/receive, buy action, watchlist action). All selectors match actual frontend component implementations.
  </done>
</task>

<task type="auto">
  <name>Task 2: docker-compose.test.yml and test execution</name>
  <files>test/docker-compose.test.yml</files>
  <action>
Create test/docker-compose.test.yml:

```yaml
services:
  app:
    build:
      context: ..
    ports:
      - "8000:8000"
    environment:
      - LLM_MOCK=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  tests:
    image: mcr.microsoft.com/playwright:v1.50.1-noble
    depends_on:
      app:
        condition: service_healthy
    working_dir: /app
    volumes:
      - .:/app
    environment:
      - BASE_URL=http://app:8000
    command: npx playwright test
    ipc: host
```

NOTE: The Playwright Docker image tag (v1.50.1-noble) MUST match the @playwright/test version in test/package.json exactly. If the npm version was adjusted during install, update the Docker image tag to match.

The build context is `..` (project root) since docker-compose.test.yml lives in test/.

To run tests locally against a running Docker container (alternative to docker-compose):
1. Start app container: docker run -d --name finally-test -p 8000:8000 -e LLM_MOCK=true finally
2. Wait for healthy: until curl -sf http://localhost:8000/api/health; do sleep 2; done
3. Run tests: cd test && npx playwright test
4. Cleanup: docker stop finally-test && docker rm finally-test
  </action>
  <verify>
Verify docker-compose.test.yml syntax: cd /Users/ed/projects/finally/test && docker compose -f docker-compose.test.yml config (should parse without errors)
Then run the full E2E suite:
1. Build and start: docker run -d --name finally-e2e -p 8000:8000 -e LLM_MOCK=true finally
2. Wait for healthy: until curl -sf http://localhost:8000/api/health; do sleep 2; done
3. Run tests: cd /Users/ed/projects/finally/test && npx playwright install chromium && npx playwright test
4. Cleanup: docker stop finally-e2e && docker rm finally-e2e
All tests should pass.
  </verify>
  <done>
docker-compose.test.yml exists with app service (LLM_MOCK=true, healthcheck) and tests service (matching Playwright Docker image). E2E tests pass against the Docker container covering: fresh start with default tickers and $10k balance, watchlist add/remove, buy/sell trades with portfolio updates, trade validation errors, and mocked AI chat with action cards.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Docker app and E2E test results</name>
  <files>none</files>
  <action>
Human verifies the Docker container serves the full application and that Playwright E2E tests passed. The container should already be running from the previous task's verify step.

Steps:
1. Open http://localhost:8000 in a browser
2. Verify the dark terminal UI loads with watchlist, charts, portfolio area, and chat panel
3. Verify prices are streaming (green/red flashing in watchlist)
4. Try a manual trade: type AAPL / 5 in the trade bar, click BUY -- cash should decrease
5. Open the AI chat, type "What is my portfolio worth?" -- should get a response
6. Review the Playwright test results output from the previous task
7. If the container is not running: docker run -d --name finally-verify -p 8000:8000 -e LLM_MOCK=true finally
  </action>
  <verify>Human confirms the application works correctly in Docker and E2E tests passed.</verify>
  <done>User has verified the Docker container serves the full FinAlly application and all E2E tests pass.</done>
</task>

</tasks>

<verification>
1. test/package.json exists with @playwright/test dependency
2. test/playwright.config.ts configures baseURL from BASE_URL env var or localhost:8000
3. 5 test spec files exist in test/tests/: fresh-start, watchlist, trading, portfolio, chat
4. test/docker-compose.test.yml defines app (with LLM_MOCK=true) and tests services
5. Playwright Docker image version matches @playwright/test npm version exactly
6. All E2E tests pass against the Docker container
7. Tests cover: fresh start (10 tickers, $10k, SSE), watchlist (add/remove), trading (buy/sell/error), portfolio (value update, table), chat (message/response, buy action, watchlist action)
</verification>

<success_criteria>
- Playwright E2E tests pass against the Docker container with LLM_MOCK=true
- Tests cover fresh start (default watchlist, $10k balance, streaming prices), watchlist CRUD (add/remove ticker), buy/sell trades (cash/position updates, validation errors), portfolio updates (value changes, positions table), and AI chat (send/receive, trade action cards, watchlist action cards)
- docker-compose.test.yml orchestrates app + Playwright containers for CI-friendly test execution
- Test selectors match actual frontend component implementations
</success_criteria>

<output>
After completion, create `.planning/phases/10-packaging-testing/10-02-SUMMARY.md`
</output>
